<!DOCTYPE html>
<html lang="pt-br">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="/static/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/ol/ol.css">

    <title>Webmap LT Tropicalia</title>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>    
    <script src="/static/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="/static/ol/dist/ol.js"></script>
    <script src="/static/elm-pep/dist/elm-pep.js"></script>

</head>

<body>
  <!-- Navbar -->
  <nav class="navbar">
      <div class="container-fluid">
          <!-- Texto "webmap" com margem e cor branca -->
          <span class="webmap-text">&nbsp;&nbsp;&nbsp;&nbsp;WEBMAP</span>
          <!-- Logo -->          
            <span class="webmap-text">&nbsp;&nbsp;&nbsp;&nbsp;T R O P I C A L I A</span>
          </a>
      </div>
  </nav>

  <!-- Mapa -->
  <div class="mapa-div">
      <div id ='js-map' class='map'></div>
  </div>
  
  <!-- Barra Lateral (Sidebar) -->
  <div class="sidebar-left" id="sidebarLeft">
      <div id="camadas_visualizacao" class="camadas_titulo"><b>Visualização</b></div>
      <div id="posicao" class="camadas">
        <h6><b>&nbsp;&nbsp;<span class="link-text" id="posicao-toggle"> > Orientação</span></b></h6>  
        <div class="expand-content" style="display: yes;" id="posicao-content">
          <div id="posicao_text">
            <b>Município:</b><br>      
            <b>Latitude:</b><br>
            <b>Longitude:</b><br>        
          </div>
        </div>
      </div>        
      <div id="camadas_lt_tropicalia" class="camadas">
        <h6><b>&nbsp;&nbsp;<span class="link-text" id="lt_tropicalia-toggle"> > Linha de transmissão</span></b></h6>
        <div class="expand-content" style="display: yes;" id="lt_tropicalia-content">
          <div id="lt_tropicalia">
            <input type="checkbox" class="camada-checkbox" id="faixa_servidao_cadastro-checkbox" value='faixa_servidao_cadastro' checked>&nbsp;&nbsp;Cadastro<br>
            <input type="checkbox" class="camada-checkbox" id="eixo-checkbox" value='eixo' >&nbsp;&nbsp;Eixo<br>
            <input type="checkbox" class="camada-checkbox" id="torres-checkbox" value='torres' >&nbsp;&nbsp;Torres<br>
            <input type="checkbox" class="camada-checkbox" id="acessos-checkbox" value='acessos' >&nbsp;&nbsp;Acessos<br>
            <input type="checkbox" class="camada-checkbox" id="edificacoes-checkbox" value='edificacoes' >&nbsp;&nbsp;Edificações<br>
            <input type="checkbox" class="camada-checkbox" id="ps_map_rf_2021-checkbox" value='ps_map_rf_2021' checked>&nbsp;&nbsp;Uso do solo (2021)<br>
            <input type="checkbox" class="camada-checkbox" id="ps_map_rf_2023-checkbox" value='ps_map_rf_2023' checked>&nbsp;&nbsp;Uso do solo (2023)<br>
          </div>
        </div>
      </div>
      <div id="camadas_alertas" class="camadas">
        <h6><b>&nbsp;&nbsp;<span class="link-text" id="alertas-toggle"> > Alertas</span></b></h6>  
        <div class="expand-content" style="display: none;" id="alertas-content">
          <div id="fluxos">
            <input type="checkbox" id="domicilio_particular-checkbox" value='domicilio_particular' >&nbsp;&nbsp;Focos de calor (INPE)<br>
            <input type="checkbox" id="domicilio_coletivo-checkbox" value='domicilio_coletivo' >&nbsp;&nbsp;Desmatamento (INPE)<br>
          </div>
          </div>
      </div>
      <div id="camadas_ambiental" class="camadas">
        <h6><b>&nbsp;&nbsp;<span class="link-text" id="ambiental-toggle"> > Ambiental</span></b></h6>  
        <div class="expand-content" style="display: none;" id="ambiental-content">
          <div id="fluxos">
            <input type="checkbox" id="domicilio_particular-checkbox" value='domicilio_particular' >&nbsp;&nbsp;Hidrografia<br>
            <input type="checkbox" id="domicilio_coletivo-checkbox" value='domicilio_coletivo' >&nbsp;&nbsp;Altitude<br>
            <input type="checkbox" id="domicilio_coletivo-checkbox" value='domicilio_coletivo' >&nbsp;&nbsp;Declividade<br>
          </div>
          </div>
      </div>
      <div id="camadas_estabelecimentos" class="camadas">
        <h6><b>&nbsp;&nbsp;<span class="link-text" id="infraestrutura-toggle"> > Social</span></b></h6>  
        <div class="expand-content" style="display: none;" id="infraestrutura-content">
          <div id="fluxos">
            <b>Infraestrutura</b><br>
            <input type="checkbox" id="domicilio_particular-checkbox" value='domicilio_particular' >&nbsp;&nbsp;Estradas<br>
            <input type="checkbox" id="domicilio_particular-checkbox" value='domicilio_particular' >&nbsp;&nbsp;Linhas de transmissão<br>
            <b>Censo 2022</b><br>
            <input type="checkbox" id="domicilio_particular-checkbox" value='domicilio_particular' >&nbsp;&nbsp;Domicílio particular<br>
            <input type="checkbox" id="domicilio_coletivo-checkbox" value='domicilio_coletivo' >&nbsp;&nbsp;Domicílio coletivo<br>
            <input type="checkbox" id="estab_agropecuario-checkbox" value='estab_agropecuario' >&nbsp;&nbsp;Estab. agropecuário<br>
            <input type="checkbox" id="estab_religioso-checkbox" value='estab_religioso' >&nbsp;&nbsp;Estab. religioso<br>
            <input type="checkbox" id="estab_ensino-checkbox" value='estab_ensino' >&nbsp;&nbsp;Estab. de ensino<br>
            <input type="checkbox" id="estab_saude-checkbox" value='estab_saude' >&nbsp;&nbsp;Estab. de saúde<br>
            <input type="checkbox" id="estab_outrasfin-checkbox" value='estab_outrasfin' >&nbsp;&nbsp;Estab. de outras finalidades<br>
            <input type="checkbox" id="edificacao_construcao-checkbox" value='edificacao_construcao' >&nbsp;&nbsp;Edificação em construção<br>
            <b>Imóveis rurais</b><br>
            <input type="checkbox" id="imoveis_rurais_car-checkbox" value='imoveis_rurais_car' >&nbsp;&nbsp;Cadastro Ambiental Rural (CAR)<br>
            <input type="checkbox" id="imoveis_rurais_sigef-checkbox" value='imoveis_rurais_sigef' >&nbsp;&nbsp;Sistema de Gestão Fundiária (SIGEF)<br>
            <input type="checkbox" id="imoveis_rurais_snci-checkbox" value='imoveis_rurais_snci' >&nbsp;&nbsp;Sistema Nacional de Cadastro Rural (SNCI)<br>
          </div>
          </div>
      </div>
      <div id="camadas_limites" class="camadas">
        <h6><b>&nbsp;&nbsp;<span class="link-text" id="limites-toggle"> > Divisão territorial</span></b></h6>  
        <div class="expand-content" style="display: none;" id="limites-content">
          <div id="limites">
            <input type="checkbox" id="assentamentos-checkbox" value='cidades'  >&nbsp;&nbsp;Cidades<br>
            <input type="checkbox" id="assentamentos-checkbox" value='povoados'  >&nbsp;&nbsp;Vilas/povoados<br>
            <input type="checkbox" id="terras_indigenas-checkbox" value='terras_indigenas' >&nbsp;&nbsp;Biomas<br>
            <input type="checkbox" id="ucs_pi-checkbox" value='ucs_pi'  >&nbsp;&nbsp;Unidade de conservação (PI)<br>
            <input type="checkbox" id="ucs_us-checkbox" value='ucs_us'  >&nbsp;&nbsp;Unidade de conservação (US)<br>
            <input type="checkbox" id="municipios-checkbox" value='setorescensitarios' >&nbsp;&nbsp;Setores censitários<br>
            <input type="checkbox" id="municipios-checkbox" value='municipios' >&nbsp;&nbsp;Municípios<br>
            <input type="checkbox" id="uf-checkbox" value='uf' >&nbsp;&nbsp;Unidade da federação<br>
          </div>
        </div>
      </div>      
      <div id="camadas_basemaps" class="camadas">
        <h6><b>&nbsp;&nbsp;<span class="link-text" id="basemaps-toggle"> > Basemap</span></b></h6>  
        <div class="expand-content" style="display: none;" id="basemaps-content">
          <div id="basemaps">
            <input type="radio" id="osm-basemap-radio" name='baseLayerRadioButton' value='osm_basemap' checked>&nbsp;&nbsp;Open Street Maps<br>
            <input type="radio" id="lulc-2022-radio" name='baseLayerRadioButton' value='br_lulc_2022' >&nbsp;&nbsp;Satélite (Planet ago/2021)<br>
            <input type="radio" id="lulc-2022-radio" name='baseLayerRadioButton' value='br_lulc_2022' >&nbsp;&nbsp;Satélite (Planet ago/2023)<br>
            <input type="radio" id="satellite-2023-radio" name='baseLayerRadioButton' value='satellite_planet' >&nbsp;&nbsp;Satélite (INPE)<br>
          </div>
        </div>                 
      </div>
      <div id="camadas_busca" class="camadas_titulo"><b>Busca</b></div>
      <div id="busca" class="busca">
        <h6><b>&nbsp;&nbsp;<span class="link-text" id="buscatorres-toggle"> > Cadastro</span></b></h6>
        <div class="expand-content" style="display: yes;" id="buscatorres-content">
        <div class="form-group">
            <form id="search-form">
              <b>&nbsp;&nbsp;Atributo:</b><br>
                <select class="custom-dropdown" name="atributo" id="atributo">
                    <option value="referencia">Referência</option>
                    <option value="projeto">Projeto</option>
                    <option value="torres">Torres</option>
                    <option value="statusnegociacao">Status da negociação</option>
                    <option value="proprietario">Proprietario</option>
                    <option value="telefone">Telefone</option>                        
                    <option value="vilapovoado">Vila ou povoado</option>
                    <option value="municipio">Municipio</option>
                </select>
                <input type="text" class="custom-input" name="valor" id="valor" list="auto-preenchimento">
                <datalist id="auto-preenchimento"></datalist>                
                                    <p style="text-align: left;">
                                      <button class="custom-button-send" type="submit">
                                        Buscar</button>
            </form>      
            <b>&nbsp;&nbsp;Desenho:</b><br>
            <button class="custom-button-draw" id="drawPolygonButton">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-fill" viewBox="0 0 16 16">
                <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/>
              </svg>&nbsp;&nbsp;Desenhar
            </button>
            <button class="custom-button-clear" id="stopDrawingButton">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eraser-fill" viewBox="0 0 16 16">
                <path d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828l6.879-6.879zm.66 11.34L3.453 8.254 1.914 9.793a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293H7.88a1 1 0 0 0 .707-.293l.16-.16z"/>
              </svg>&nbsp;&nbsp;Limpar</button>         
        </div>
        </div>            
       <br>
       <br>
       <br>
  </div>
  <div class="sidebar-right" id="sidebarRight">
      <div id="relatorios_titulo" class="relatorios_titulo"><b>Relatório</b></div>
      <div id="rel_torre" class="relatorios">
          <h6><b>&nbsp;&nbsp;<span class="link-text"> > Cadastro</span></b></h6>
          <div class="expand-content" style="display: yes;">
          <div id="rel_torre_tab">            
          <div id="resultados">
              <table class="table custom-table-width rounded-table small-table">                
              <tbody>
                  <tr id="referenciaRow">
                      <td class="small-font"><b>Referência:</b> </td>
                  </tr>
                  <tr id="projetoRow">
                      <td class="small-font"><b>Projeto:</b> </td>
                  </tr>   
                  <tr id="torresRow">
                      <td class="small-font"><b>Torres:</b> </td>
                  </tr>  
                  <tr id="statusnegociacaoRow">
                      <td class="small-font"><b>Status de Negociação:</b> </td>
                  </tr>  
                  <tr id="proprietarioRow">
                    <td class="small-font"><b>Proprietário:</b> </td>
                </tr>
                  <tr id="telefoneRow">
                      <td class="small-font"><b>Telefone:</b> </td>
                  </tr>
                  <tr id="vilapovoadoRow">
                      <td class="small-font"><b>Vila/Povoado:</b> </td>
                  </tr>
                  <tr id="municipioRow">
                      <td class="small-font"><b>Município:</b> </td>
                  </tr>
              </tbody>
          </table>
          </div>
          <div id="paginacao">
          </div>
      </div>
      </div>
      </div>
      <div id="rel_raio10km" class="relatorios">
          <h6><b>&nbsp;&nbsp; <span class="link-text">> Caracterização (até 450 metros do eixo)</span></b></h6>                   
          <div class="expand-content" style="display: none;">
              <div id="resultados_10km">  
              <table class="table custom-table-width rounded-table small-table">
              <thead>
                  <tr>
                      <th class="small-font">Base fundiária</th>
                      <th class="small-font text-center">Qtd. imóveis</th>
                      <th class="small-font text-center">Tamanho médio (ha)</th>
                    </tr>
              </thead>
              <tbody>
                  <tr>
                      <td class="small-font">CAR</td>
                      <td id="car_qtd_7km_tab" class="small-font text-center" ></td>
                      <td id="car_areamedia_tab" class="small-font text-center"></td>
                  </tr>
                  <tr>
                      <td id="" class="small-font">SIGEF</td>
                      <td id="sigef_qtd_7km_tab" class="small-font text-center"></td>
                      <td id="sigef_areamedia_tab" class="small-font text-center"></td>
                  </tr>
                  <tr>
                      <td id="" class="small-font">SNCI</td>
                      <td id="snci_qtd_7km_tab" class="small-font text-center"></td>
                      <td id="snci_areamedia_tab" class="small-font text-center"></td>
                  </tr>
              </tbody>
          </table>
          <table class="table custom-table-width rounded-table small-table">
              <tbody>
                  <tr>
                      <td class="small-font"><b>Área total (raio 450 m):</b></td>
                      <td id="qto_armzs_7km_tab" class="small-font"></td>
                  </tr>
                  <tr>
                      <td class="small-font"><b>Qtd edificações (raio 450 m): </b></td>
                      <td id="cap_ton_7km_tab" class="small-font"></td>
                  </tr>   
                  <tr>
                      <td class="small-font"><b>Qtd edificações (faixa de servidão):</b></td>
                      <td id="usinas_qtd_7km_tab" class="small-font"></td>
                  </tr>
                  <tr>
                      <td class="small-font"><b>Torres (qtd): </b></td>
                      <td id="frigorificos_qtd_7km_tab" class="small-font"></td>
                  </tr>
              </tbody>
          </table>
          <table class="table custom-table-width rounded-table small-table">
              <thead>
                  <tr>
                      <th class="small-font">Uso/cobertura do solo</th>
                      <th class="small-font">Área (2021)</th>
                      <th class="small-font">Área (2023)</th>
                    </tr>
              </thead>
              <tbody>
                  <tr>
                      <td class="small-font">Formação campestre</td>
                      <td id="lulc_soja_tab" class="small-font" ></td>
                      <td id="lulc_soja_tab" class="small-font" ></td>
                  </tr>
                  <tr>
                      <td class="small-font">Pastagem</td>
                      <td id="outras_lav_temporarias_tab" class="small-font"></td>
                      <td id="outras_lav_temporarias_tab" class="small-font"></td>
                  </tr>   
                  <tr>
                      <td class="small-font">Mosaico de usos</td>
                      <td id="lulc_cana_tab" class="small-font"></td>
                      <td id="lulc_cana_tab" class="small-font"></td>
                  </tr>
                  <tr>
                      <td class="small-font">Área urbanizada</td>
                      <td id="lav_perenes_tab" class="small-font"></td>
                      <td id="lav_perenes_tab" class="small-font"></td>
                  </tr>
                  <tr>
                      <td class="small-font">Outras áreas não vegetadas</td>
                      <td id="lulc_pastagem_tab" class="small-font"></td>
                      <td id="lulc_pastagem_tab" class="small-font"></td>
                  </tr>
                  <tr>
                      <td class="small-font">Formação florestal</td>
                      <td id="lulc_silvicultura_tab" class="small-font"></td>
                      <td id="lulc_silvicultura_tab" class="small-font"></td>
                  </tr>
                  <tr>
                      <td class="small-font">Água</td>
                      <td id="lulc_areaurbanizada_tab" class="small-font"></td>
                      <td id="lulc_areaurbanizada_tab" class="small-font"></td>
                  </tr>
                  <tr>
                      <td class="small-font">Formação savânica</td>
                      <td id="lulc_riolagoeoceano_tab" class="small-font"></td>
                      <td id="lulc_riolagoeoceano_tab" class="small-font"></td>
                  </tr>
                  <tr>
                      <td class="small-font">Campo alagado e área pantanosa</td>
                      <td id="veg_nativa_tab" class="small-font"></td>
                      <td id="veg_nativa_tab" class="small-font"></td>
                  </tr>
              </tbody>
          </table>
          <table class="table custom-table-width rounded-table small-table">
              <thead>
                  <tr>
                      <th class="small-font">Unidades de conservação</th>
                      <th class="small-font">Quantidade</th>
                      <th class="small-font">Área (ha)</th>
                    </tr>
              </thead>
              <tbody>
                  <tr>
                      <td class="small-font">Proteção Integral</td>
                      <td id="ucpi_qtd_7km_tab" class="small-font text-center"></td>
                      <td id="ucpi_area_7km_tab" class="small-font"></td>
                  </tr>
                  <tr>
                      <td class="small-font">Uso Sustentável</td>
                      <td id="ucus_qtd_7km_tab" class="small-font text-center"></td>
                      <td id="ucus_area_7km_tab" class="small-font"></td>
                  </tr>
              </tbody>
              <table class="table custom-table-width rounded-table small-table">
                <thead>
                    <tr>
                        <th class="small-font">Tipos de estabelecimentos (Censo 2022)</th>
                        <th class="small-font">Quantidade</th>
                      </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="small-font">Domicílio particular</td>
                        <td id="assent_qtd_7km_tab" class="small-font text-center"></td>
                    </tr>
                    <tr>
                        <td class="small-font">Domicílio coletivo</td>
                        <td id="ti_qtd_7km_tab" class="small-font text-center"></td>
                        
                    </tr>   
                    <tr>
                        <td class="small-font">Estabelecimento agropecuário</td>
                        <td id="ucpi_qtd_7km_tab" class="small-font text-center"></td>
                    </tr>
                    <tr>
                        <td class="small-font">Estabelecimento de saúde</td>
                        <td id="ucus_qtd_7km_tab" class="small-font text-center"></td>
                    </tr>
                    <tr>
                      <td class="small-font">Estabelecimento de ensino</td>
                      <td id="ucus_qtd_7km_tab" class="small-font text-center"></td>
                  </tr>
                  <tr>
                    <td class="small-font">Estabelecimento religioso</td>
                    <td id="ucus_qtd_7km_tab" class="small-font text-center"></td>
                  </tr>
                  <tr>
                    <td class="small-font">Estabelecimento de outras finalidades</td>
                    <td id="ucus_qtd_7km_tab" class="small-font text-center"></td>
                  </tr>
                  <tr>
                    <td class="small-font">Edificação em construção</td>
                    <td id="ucus_qtd_7km_tab" class="small-font text-center"></td>
                  </tr>
                </tbody>
          </table>
          </div>  
          </div>
      </div>
      
      <div id="relatorios_titulo" class="relatorios_titulo"><b>Legenda</b></div>
      <div id="legenda" class="legenda">
          <img src="images/" max-width: 180px>
          <br>
          <br>
          <br>
          <br>
          <br>
      </div>
  </div>

  <!-- Botão de revelação para a barra lateral esquerda -->
  <button class="custom-toggler custom-toggler-left" id="toggleSidebarLeft">&RightArrowBar;</button>
  
  <!-- Botão de revelação para a barra lateral direita -->
  <button class="custom-toggler custom-toggler-right" id="toggleSidebarRight">&LeftArrowBar;</button>

  <script>

  // Adicione um evento de clique para cada <h6> dentro das divs "relatorios"
  const headers = document.querySelectorAll('.relatorios h6');
  headers.forEach(header => {
    header.addEventListener('click', () => {

      // Encontre o elemento <p> seguinte ao <h6>
      const content = header.nextElementSibling;

      // Alterne a visibilidade do conteúdo usando a propriedade CSS 'display'
      if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
      } else {
        content.style.display = 'none';
      }
    });
  });


  
  window.onload = init;
  
  function init() {
    let pointLayer
    let pointLayer_sel
    let pointLayer_sel_v2
    let vectorLayer  

    const attributionControl = new ol.control.Attribution({
      collapsible: true
    });  
  
    const view = new ol.View({
      center: [-39.8, -13.55],
      zoom: 9.5,
      projection: 'EPSG:4326',
    });

    const map = new ol.Map({
      view: view,
      layers: [
        new ol.layer.Tile({
          source: new ol.source.OSM({

          }),
          visible: true
        }),
      ],
      target: "js-map"
    });  

    const info_torres = new ol.source.TileWMS({
      ratio: 1,
      url: 'http://localhost:8080/geoserver/tropicalia/wms',
      params: {'VERSION': '1.1.0',  
            "STYLES": '',
            "LAYERS": 'tropicalia:faixa_servidao_cadastro ',
            "exceptions": 'application/vnd.ogc.se_inimage',
      }
    })

    const info_municipios = new ol.source.TileWMS({
      ratio: 1,
      url: 'http://localhost:8080/geoserver/limites/wms',
      params: {'VERSION': '1.1.0',  
            "STYLES": '',
            "LAYERS": 'limites:pa_br_ibge_municipios_2022',
            "exceptions": 'application/vnd.ogc.se_inimage',
      }
    })

    const faixa_servidao_cadastro = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/tropicalia/wms?service=WMS&version=1.1.0&request=GetMap&layers=tropicalia%3Afaixa_servidao_cadastro',
      }),
      visible: true,
      title: 'faixa_servidao_cadastro'
    });

    const eixo = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/tropicalia/wms?service=WMS&version=1.1.0&request=GetMap&layers=tropicalia%3Aeixo',
      }),
      visible: false,
      title: 'eixo'
    });

    const torres = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/tropicalia/wms?service=WMS&version=1.1.0&request=GetMap&layers=tropicalia%3Atorres',
      }),
      visible: false,
      title: 'torres'
    });

    const edificacoes = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/tropicalia/wms?service=WMS&version=1.1.0&request=GetMap&layers=tropicalia%3Aedificacoes',
      }),
      visible: false,
      title: 'edificacoes'
    });

    const acessos = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/tropicalia/wms?service=WMS&version=1.1.0&request=GetMap&layers=tropicalia%3Aacessos',
      }),
      visible: false,
      title: 'acessos'
    });

    const ps_map_rf_2021 = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/tropicalia/wms?service=WMS&version=1.1.0&request=GetMap&layers=tropicalia%3Aps_map_rf_2021',
      }),
      visible: true,
      title: 'ps_map_rf_2021'
    });

    const ps_map_rf_2023 = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/tropicalia/wms?service=WMS&version=1.1.0&request=GetMap&layers=tropicalia%3Aps_map_rf_2023',
      }),
      visible: true,
      title: 'ps_map_rf_2023'
    });

    const imoveis_rurais_car = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/fundiario/wms?service=WMS&version=1.1.0&request=GetMap&layers=fundiario%3Apa_br_car_areaimovel_11042023',
      }),
      visible: false,
      title: 'imoveis_rurais_car'
    });

    const imoveis_rurais_sigef = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/fundiario/wms?service=WMS&version=1.1.0&request=GetMap&layers=fundiario%3Apa_br_sigef_areaimovel_24092023',
      }),
      visible: false,
      title: 'imoveis_rurais_sigef'
    });

    const imoveis_rurais_snci = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/fundiario/wms?service=WMS&version=1.1.0&request=GetMap&layers=fundiario%3Apa_br_snci_imovelcertificado_24092023',
      }),
      visible: false,
      title: 'imoveis_rurais_snci'
    });

    const assentamentos = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/fundiario/wms?service=WMS&version=1.1.0&request=GetMap&layers=fundiario%3Apa_br_incra_assentamentos_24092023',
      }),
      visible: false,
      title: 'assentamentos'
    });

    const terras_indigenas = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/fundiario/wms?service=WMS&version=1.1.0&request=GetMap&layers=fundiario%3Apa_br_funai_terrasindigenas_16072021',
      }),
      visible: false,
      title: 'terras_indigenas'
    });

    const ucs_pi = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/limites/wms?service=WMS&version=1.1.0&request=GetMap&layers=limites%3Apa_br_mma_ucs_pi_16072021',
      }),
      visible: false,
      title: 'ucs_pi'
    });

    const ucs_us = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/limites/wms?service=WMS&version=1.1.0&request=GetMap&layers=limites%3Apa_br_mma_ucs_us_16072021',
      }),
      visible: false,
      title: 'ucs_us'
    });

    const municipios = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/limites/wms?service=WMS&version=1.1.0&request=GetMap&layers=limites%3Apa_br_ibge_municipios_2022',
      }),
      visible: false,
      title: 'municipios'
    });

    const uf = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/limites/wms?service=WMS&version=1.1.0&request=GetMap&layers=limites%3Apa_br_ibge_uf_2022',
      }),
      visible: false,
      title: 'uf'
    });

    const osm_basemap = new ol.layer.Tile({
      source: new ol.source.OSM(),    
      visible: true,
      title: 'osm_basemap'        
    })

    const br_lulc_2022 = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'http://localhost:8080/geoserver/ne/wms?service=WMS&version=1.1.0&request=GetMap&layers=ne%3Abrasil_coverage_2022',
      }),
      visible: false,
      title: 'br_lulc_2022'
    });

    const satelite_planet = new ol.layer.Tile({
      source: new ol.source.XYZ({
          url: 'https://tiles{0-3}.planet.com/basemaps/v1/planet-tiles/planet_medres_visual_2022-08_mosaic/gmap/{z}/{x}/{y}.png?api_key=PLAKdea77c92bc87478d9c51e3cc19c5a7fd',
      }),
      visible: false,
      title: 'satelite_planet'
    })   

    const checkboxGroup = new ol.layer.Group({
      layers: [
      ps_map_rf_2021, ps_map_rf_2023, uf, municipios, ucs_pi, ucs_us, terras_indigenas, assentamentos, imoveis_rurais_snci, imoveis_rurais_sigef, imoveis_rurais_car, torres, edificacoes, faixa_servidao_cadastro, eixo, acessos
      ]
    });

    const baseLayerGroup = new ol.layer.Group({
      layers: [
        osm_basemap, br_lulc_2022, satelite_planet
      ]
    })
  
    // Adicione um ID único a cada camada  
    faixa_servidao_cadastro.set('layerId', 'faixa_servidao_cadastroLayer');
    eixo.set('layerId', 'eixoLayer');
    torres.set('layerId', 'torresLayer');
    acessos.set('layerId', 'acessosLayer');
    edificacoes.set('layerId', 'edificacoesLayer');
    ps_map_rf_2021.set('layerId', 'ps_map_rf_2021Layer');
    ps_map_rf_2023.set('layerId', 'ps_map_rf_2023Layer');
    imoveis_rurais_car.set('layerId', 'imoveis_rurais_carLayer');
    imoveis_rurais_sigef.set('layerId', 'imoveis_rurais_sigefLayer');
    imoveis_rurais_snci.set('layerId', 'imoveis_rurais_snciLayer');
    assentamentos.set('layerId', 'assentamentosLayer');
    terras_indigenas.set('layerId', 'terras_indigenasLayer');
    ucs_pi.set('layerId', 'ucs_piLayer');
    ucs_us.set('layerId', 'ucs_usLayer');
    municipios.set('layerId', 'municipiosLayer');
    uf.set('layerId', 'ufLayer');
  
    // Adicione as camadas ao mapa OpenLayers  
    map.addLayer(faixa_servidao_cadastro);
    map.addLayer(eixo);
    map.addLayer(torres);
    map.addLayer(acessos);
    map.addLayer(edificacoes);
    map.addLayer(ps_map_rf_2021);
    map.addLayer(ps_map_rf_2023);
    map.addLayer(imoveis_rurais_car);
    map.addLayer(imoveis_rurais_sigef);
    map.addLayer(imoveis_rurais_snci);
    map.addLayer(assentamentos);
    map.addLayer(terras_indigenas);
    map.addLayer(ucs_pi);
    map.addLayer(ucs_us);
    map.addLayer(municipios);
    map.addLayer(uf);
    map.addLayer(baseLayerGroup);
    map.addLayer(checkboxGroup);
    map.removeControl(map.getControls().getArray().find(control => control instanceof ol.control.Zoom));
  
    // Seleciona os radio buttons  
    const osmBasemapRadio = document.getElementById("osm-basemap-radio");
    const lulc2022Radio = document.getElementById("lulc-2022-radio");
    const satellite2023Radio = document.getElementById("satellite-2023-radio");
  
    // Adiciona eventos de mudança aos radio buttons para alternar entre as camadas de mapa base  
    osmBasemapRadio.addEventListener("change", () => {
      if (osmBasemapRadio.checked) {
        osm_basemap.setVisible(true);
        br_lulc_2022.setVisible(false);
        satelite_planet.setVisible(false);
      }
    });

    lulc2022Radio.addEventListener("change", () => {
      if (lulc2022Radio.checked) {
        osm_basemap.setVisible(false);
        br_lulc_2022.setVisible(true);
        satelite_planet.setVisible(false);
      }
    });
  
    satellite2023Radio.addEventListener("change", () => {
      if (satellite2023Radio.checked) {
        osm_basemap.setVisible(false);
        br_lulc_2022.setVisible(false);
        satelite_planet.setVisible(true);
      }
    });

    var info = document.getElementById('info');

    // Mapeamento de alias para nomes de colunas    
    const columnAlias = {
      referencia: 'Referência',
      projeto: 'Projeto',
      torres: 'Torres',
      statusnegociacao: 'Status da negociação',
      proprietario: 'Proprietário',
      telefone: 'telefone',
      vilapovoado: 'Vila ou Povoado',
      municipio: 'Município',
    };
  
    // Definição de vegetação nativa
    const veg_nativa = {
      lulc_formacaoflorestal: 0,
      lulc_formacaosavanica: 0,
      lulc_mangue: 0,
      lulc_florestaalagavel: 0,
      lulc_campoalagadoeareapantanosa: 0,
      lulc_formacaocampestre: 0,
      lulc_pastagem: 0,
      lulc_restingaarborea: 0,
      lulc_restingaherbacea: 0
    };
    // Definição de lavouras perenes
    const lav_perenes = {
      lulc_cafe: 0,
      lulc_citrus: 0,
      lulc_outraslavourasperenes: 0 
    };
    // Definição de outras lavouras temporarias
    const outras_lav_temporarias = {
      lulc_arroz: 0,
      lulc_algodao: 0,
      lulc_outraslavourastemporarias: 0 
    };
    // Mapeamento de campos adicionais para IDs de células
    const fieldCellIds = {
      cap_ton_7km: 'cap_ton_7km_tab',
      qto_armzs_7km: 'qto_armzs_7km_tab',
      assent_area_7km: 'assent_area_7km_tab',
      assent_qtd_7km: 'assent_qtd_7km_tab',
      ti_area_7km: 'ti_area_7km_tab',
      ti_qtd_7km: 'ti_qtd_7km_tab',
      ucus_area_7km: 'ucus_area_7km_tab',
      ucus_qtd_7km: 'ucus_qtd_7km_tab',
      ucpi_area_7km: 'ucpi_area_7km_tab',
      ucpi_qtd_7km: 'ucpi_qtd_7km_tab',
      car_areamedia: 'car_areamedia_tab',
      car_qtd_7km: 'car_qtd_7km_tab',
      sigef_areamedia: 'sigef_areamedia_tab',
      sigef_qtd_7km: 'sigef_qtd_7km_tab',
      snci_areamedia: 'snci_areamedia_tab',
      snci_qtd_7km: 'snci_qtd_7km_tab',
      usinas_qtd_7km: 'usinas_qtd_7km_tab',
      frigorificos_qtd_7km: 'frigorificos_qtd_7km_tab',
      lulc_cana: 'lulc_cana_tab',
      lulc_soja: 'lulc_soja_tab',
      lulc_pastagem: 'lulc_pastagem_tab',
      lulc_silvicultura: 'lulc_silvicultura_tab',
      lulc_riolagoeoceano: 'lulc_riolagoeoceano_tab',
      lulc_areaurbanizada: 'lulc_areaurbanizada_tab'                      
    };
  
    // Adicione a funcionalidade de auto preenchimento
    $('#valor').on('input', function () {
      const atributo = $('[name="atributo"]').val();
      const valor = $(this).val();
      $.get('/buscar_valores', { atributo, valor }, function (response) {
        const autoPreenchimento = $('#auto-preenchimento');
        autoPreenchimento.empty(); // Limpa a lista de auto preenchimento

        // Adicione cada valor retornado como uma opção na lista de auto preenchimento
        response.forEach(function (valor) {
          autoPreenchimento.append('<option value="' + valor + '">');
        });
      });
    });
  
    drawPolygonButton.addEventListener('click', () => {    
      map.removeLayer(vectorLayer); 
      map.removeLayer(pointLayer); 

      // Ativar a ferramenta de desenho
      draw = new ol.interaction.Draw({
        source: new ol.source.Vector(),
        type: 'Polygon', // Isso permite desenhar polígonos
      });
      map.addInteraction(draw);    
    
      draw.on('drawend', (event) => {
        const polygonFeature = event.feature;
        const polygonGeometry = polygonFeature.getGeometry();
        const coordinates = polygonGeometry.getCoordinates()[0]; 
      
        // Construir a string de coordenadas do polígono
        const polygonCoordinates = coordinates.map(coord => coord.join(' ')).join(', ');
      
        // Fazer uma solicitação POST para a rota do servidor usando $.ajax
        $.ajax({
          type: 'POST',
          url: '/verificar_pontos_no_poligono', // Ajuste o URL conforme necessário
          data: { polygonCoordinates },
          success: function (response) {
            console.log(response)

            // Limpar o conteúdo atual da tabela
            $('#resultados tbody tr').each(function () {
              $(this).find('td').html('');
            });
            if (response.pointsInPolygon && response.pointsInPolygon.length > 0) {

              // Criar um formato para ler as geometrias WKT
              const wkbFormat = new ol.format.WKB();

              // Criar uma fonte de vetor para a camada de pontos
              const pointSource = new ol.source.Vector();

              // Iterar sobre os pontos na resposta
              response.pointsInPolygon.forEach(function (result, index) {         

                // Ler a geometria WKN da coluna "geom"
                const geometry = wkbFormat.readGeometry(result.geom);
              
                // Criar um recurso de vetor com a geometria
                const pointFeature = new ol.Feature({
                  geometry: geometry,
                });
              
                // Adicionar o recurso à fonte de vetor
                pointSource.addFeature(pointFeature);
              });
            
              // Criar uma camada de vetor para os pontos
              pointLayer = new ol.layer.Vector({
                source: pointSource,
                style: new ol.style.Style({
                  image: new ol.style.Icon({
                    src: '/images/icon_grey.png',
                    scale: 1,
                  }),
                }),
              });
            
              // Adicionar a camada de vetor dos pontos ao mapa
              map.addLayer(pointLayer);

              // Obtenha o extent da camada
              const extent = pointLayer.getSource().getExtent();
              
              // Acesse a visão (view) do mapa
              const view = map.getView();

              // Obtenha a resolução do zoom adequada para cobrir o extent da camada
              const resolution = view.getResolutionForExtent(extent, map.getSize());
              
              // Defina o nível de zoom desejado (por exemplo, três níveis abaixo)
              const desiredZoomLevel = view.getZoomForResolution(resolution) - 2;

              // Defina o nível de zoom máximo desejado
              const maxZoomLevel = 21; // Substitua pelo valor máximo desejado

              // Garanta que o nível de zoom desejado não exceda o nível máximo              
              const zoomLevel = Math.min(desiredZoomLevel, maxZoomLevel);

              // Configure a nova resolução com base no novo nível de zoom
              const newResolution = view.getResolutionForZoom(zoomLevel);

              // Configure o centro da visão no centro do extent da camada
              view.setCenter(ol.extent.getCenter(extent));

              // Defina a nova resolução
              view.setResolution(newResolution);

              // Criar o menu dropdown e preencher com os resultados
              const dropdown = $('<select>');
              dropdown.attr('id', 'resultado-dropdown');
              dropdown.addClass('custom-dropdown-pag'); // Adicionar classe de estilo personalizado   
              
              // Adicionar uma opção para cada resultado
              response.pointsInPolygon.forEach(function (result, index) { 

                // Verifique se há uma camada de pontos selecionada anteriormente e remova-a                      
                map.removeLayer(pointLayer_sel); 
                map.removeLayer(pointLayer_sel_v2);

                // Crie uma fonte de vetor para a camada de pontos
                pointSource_sel = new ol.source.Vector();

                // Converta a geometria WKB em um formato que o OpenLayers possa entender
                wkb_sel = new ol.format.WKB();
                geometry_sel = wkb_sel.readGeometry(result.geom);

                // Crie um novo ponto com a geometria selecionada e o ícone desejado
                pointFeature_sel = new ol.Feature({
                  geometry: geometry_sel,
                });              
              
                // Adicione o recurso à fonte de vetor
                pointSource_sel.addFeature(pointFeature_sel);
              
                // Crie uma camada de vetor para os pontos
                pointLayer_sel = new ol.layer.Vector({
                  source: pointSource_sel,
                  style: new ol.style.Style({
                    image: new ol.style.Icon({
                      src: 'images/icon_black.png', // Ícone vermelho
                      scale: 1,
                    }),
                  }),
                });
              
                // Adicione a camada de vetor dos pontos ao mapa
                map.addLayer(pointLayer_sel);
                dropdown.append(
                  $('<option>', {
                    value: JSON.stringify(result),
                    text: result.referencia, // Usar result.referencia como o texto
                  })
                );              
              });
              // Adicionar um ouvinte de evento de alteração ao menu dropdown
              dropdown.on('change', function () {
                selectedValue = JSON.parse($(this).val()); // Converter de volta para objeto

                // Verifique se há uma camada de pontos selecionada anteriormente e remova-a
                if (pointLayer_sel) {
                  map.removeLayer(pointLayer_sel);
                  map.removeLayer(pointLayer_sel_v2);
                }
                // Crie uma fonte de vetor para a camada de pontos
                pointSource_sel = new ol.source.Vector();

                // Converta a geometria WKB em um formato que o OpenLayers possa entender
                wkb_sel = new ol.format.WKB();
                geometry_sel = wkb_sel.readGeometry(selectedValue.geom);

                // Crie um novo ponto com a geometria selecionada e o ícone desejado
                pointFeature_sel = new ol.Feature({
                  geometry: geometry_sel,
                });              
              
                // Adicione o recurso à fonte de vetor
                pointSource_sel.addFeature(pointFeature_sel);
              
                // Crie uma camada de vetor para os pontos
                pointLayer_sel = new ol.layer.Vector({
                  source: pointSource_sel,
                  style: new ol.style.Style({
                    image: new ol.style.Icon({
                      src: 'images/icon_black.png', // Ícone vermelho
                      scale: 1,
                    }),
                  }),
                });
              
                // Adicione a camada de vetor dos pontos ao mapa
                map.addLayer(pointLayer_sel);
                displaySelectedResult(selectedValue) 
              });

              // Exibir o menu dropdown na div com id "paginacao"
              $('#paginacao').empty().append(dropdown).append('&nbsp;&nbsp;&nbsp;(' + response.pointsInPolygon.length + ' resultados)');
              // Exibir o primeiro resultado por padrão (opcional)

              if (response.pointsInPolygon.length > 0) {
                dropdown.val(JSON.stringify(response.pointsInPolygon[response.pointsInPolygon.length-1]));
                displaySelectedResult(response.pointsInPolygon[response.pointsInPolygon.length-1]);
              }
            } else {

              // Se não houver resultados, você pode exibir uma mensagem na tabela
              $('#referenciaRow td').html('Nenhum resultado encontrado.');
              $('#paginacao').empty(); // Limpar o menu dropdown
            }
          },
          error: function (error) {
            console.error('Erro ao verificar os pontos no polígono:', error);
          }
        });
      
        // Remover a interação de desenho
        map.removeInteraction(draw);
      
        // Criar uma nova camada de vetor com a feature do polígono desenhado
        vectorLayer = new ol.layer.Vector({
          source: new ol.source.Vector({
            features: [polygonFeature], // Adicionar a feature à fonte de vetor
          }),
        });    
        // Adicionar a camada de vetor ao mapa
        map.addLayer(vectorLayer);
      });  
    });
  
    stopDrawingButton.addEventListener('click', () => {
      // Parar a ferramenta de desenho
      map.removeInteraction(draw);
    
      // Remover a camada de vetor, se existir
      if (vectorLayer) {
        map.removeLayer(vectorLayer); 
        map.removeLayer(pointLayer)    
      }
    });      
  
    $('#search-form').submit(function (e) {
      e.preventDefault(); // Impede o envio do formulário padrão

      const atributo = $('[name="atributo"]').val();
      const valor = $('[name="valor"]').val();

      $.ajax({
        type: 'POST',
        url: '/buscar',
        data: { atributo, valor },
        success: function (response) {

          map.removeLayer(pointLayer); 

          console.log(response)

          // Limpar o conteúdo atual da tabela
          $('#resultados tbody tr').each(function () {
            $(this).find('td').html('');
          });

          // Verificar se há resultados na resposta do servidor
          if (response.rows && response.rows.length > 0) {     

            // Criar um formato para ler as geometrias WKT
            const wkbFormat = new ol.format.WKB();

            // Criar uma fonte de vetor para a camada de pontos
            const pointSource = new ol.source.Vector();

            // Iterar sobre os pontos na resposta            
            response.rows.forEach(function (result, index) {    
              
              // Ler a geometria WKN da coluna "geom"
              const geometry = wkbFormat.readGeometry(result.geom);
            
              // Criar um recurso de vetor com a geometria
              const pointFeature = new ol.Feature({
                geometry: geometry,
              });
            
              // Adicionar o recurso à fonte de vetor
              pointSource.addFeature(pointFeature);
            });
          
            // Criar uma camada de vetor para os pontos
            pointLayer = new ol.layer.Vector({
              source: pointSource,
              style: new ol.style.Style({
                image: new ol.style.Icon({
                  src: '/images/icon_grey.png',
                  scale: 1,
                }),
              }),
            });
          
            // Adicionar a camada de vetor dos pontos ao mapa
            map.addLayer(pointLayer);
            
            const extent = pointLayer.getSource().getExtent(); // Obtenha o extent da camada            
            const view = map.getView(); // Acesse a visão (view) do mapa             
            const resolution = view.getResolutionForExtent(extent, map.getSize()); // Obtenha a resolução do zoom adequada para cobrir o extent da camada
            const desiredZoomLevel = view.getZoomForResolution(resolution) - 2; // Defina o nível de zoom desejado (por exemplo, três níveis abaixo)            
            const maxZoomLevel = 13; // Defina o nível de zoom máximo desejado           
            const zoomLevel = Math.min(desiredZoomLevel, maxZoomLevel); // Garanta que o nível de zoom desejado não exceda o nível máximo
            const newResolution = view.getResolutionForZoom(zoomLevel); // Configure a nova resolução com base no novo nível de zoom    

            view.setCenter(ol.extent.getCenter(extent)); // Configure o centro da visão no centro do extent da camada             
            view.setResolution(newResolution); // Defina a nova resolução

            // Criar o menu dropdown e preencher com os resultados
            const dropdown = $('<select>');
            dropdown.attr('id', 'resultado-dropdown');
            dropdown.addClass('custom-dropdown-pag');

            // Adicionar uma opção para cada resultado
            response.rows.forEach(function (result, index) {    

                // Verifique se há uma camada de pontos selecionada anteriormente e remova-a                      
                map.removeLayer(pointLayer_sel); 
                map.removeLayer(pointLayer_sel_v2);                                  
            
                // Crie uma fonte de vetor para a camada de pontos
                pointSource_sel = new ol.source.Vector();
            
                // Converta a geometria WKB em um formato que o OpenLayers possa entender
                wkb_sel = new ol.format.WKB();
                geometry_sel = wkb_sel.readGeometry(result.geom);  

                // Crie um novo ponto com a geometria selecionada e o ícone desejado
                pointFeature_sel = new ol.Feature({
                  geometry: geometry_sel,
                });              
              
                // Adicione o recurso à fonte de vetor
                pointSource_sel.addFeature(pointFeature_sel);
              
                // Crie uma camada de vetor para os pontos
                pointLayer_sel = new ol.layer.Vector({
                  source: pointSource_sel,
                  style: new ol.style.Style({
                    image: new ol.style.Icon({
                      src: 'images/icon_black.png', // Ícone vermelho
                      scale: 1,
                    }),
                  }),
                });
              
                // Adicione a camada de vetor dos pontos ao mapa
                map.addLayer(pointLayer_sel);

              dropdown.append(

                $('<option>', {
                  value: JSON.stringify(result),
                  text: result.referencia, // Usar result.referencia como o texto                  
                })

              );
            });

            // Adicionar um ouvinte de evento de alteração ao menu dropdown
            dropdown.on('change', function () {
              const selectedValue = JSON.parse($(this).val()); // Converter de volta para objeto

              // Verifique se há uma camada de pontos selecionada anteriormente e remova-a
              if (pointLayer_sel) {
                map.removeLayer(pointLayer_sel);
                map.removeLayer(pointLayer_sel_v2);
              }
              
              // Crie uma fonte de vetor para a camada de pontos
              pointSource_sel = new ol.source.Vector();

              // Converta a geometria WKB em um formato que o OpenLayers possa entender
              wkb_sel = new ol.format.WKB();
              geometry_sel = wkb_sel.readGeometry(selectedValue.geom);

              // Crie um novo ponto com a geometria selecionada e o ícone desejado
              pointFeature_sel = new ol.Feature({
                geometry: geometry_sel,
              });              
            
              // Adicione o recurso à fonte de vetor
              pointSource_sel.addFeature(pointFeature_sel);
            
              // Crie uma camada de vetor para os pontos
              pointLayer_sel = new ol.layer.Vector({
                source: pointSource_sel,
                style: new ol.style.Style({
                  image: new ol.style.Icon({
                    src: 'images/icon_black.png', // Ícone vermelho
                    scale: 1,
                  }),
                }),
              });
            
              // Adicione a camada de vetor dos pontos ao mapa
              map.addLayer(pointLayer_sel);

              displaySelectedResult(selectedValue);
            });

            // Exibir o menu dropdown na div com id "paginacao"
            $('#paginacao').empty().append(dropdown).append('&nbsp;&nbsp;&nbsp;(' + response.rows.length + ' resultados)');

            // Exibir o primeiro resultado por padrão (opcional)
            if (response.rows.length > 0) {
              dropdown.val(JSON.stringify(response.rows[response.rows.length-1]));
              displaySelectedResult(response.rows[response.rows.length-1]);
            }
          } else {

            // Se não houver resultados, você pode exibir uma mensagem na tabela
            $('#referenciaRow td').html('Nenhum resultado encontrado.');
            $('#paginacao').empty(); // Limpar o menu dropdown
          }
        },

        error: function (error) {
          console.error('Erro ao fazer a solicitação:', error);
        },
      });
    });
  
    // Função para exibir um resultado selecionado
    function displaySelectedResult(result) {
      // Criar a tabela com o layout personalizado
      const table = $('<table>', {
        class: 'table custom-table-width rounded-table small-table',
      });
    
      const tbody = $('<tbody>');
      
      // Mapeamento de alias para nomes de colunas
      for (const key in result) {
        if (columnAlias.hasOwnProperty(key)) {
          const row = $('<tr>', {
            id: key + 'Row',
          });

          const columnName = columnAlias[key];
          const cell = $('<td>', {
            class: 'small-font',
            html: '<b>' + columnName + ':</b> ' + result[key],
          });

          row.append(cell);
          tbody.append(row);
        }
      }

      table.append(tbody);
    
      // Exibir a tabela na div com id "resultados"
      $('#resultados').html(table);
    
      // Limpar campos sem dados e preencher com 0
      for (const key in fieldCellIds) {
          const cellId = fieldCellIds[key];
          $('#' + cellId).html('0'); // Preencher com 0 se o valor estiver em branco
        }
      
      // Preencher células adicionais com valores dos campos adicionais
      for (const key in result) {
          if (fieldCellIds.hasOwnProperty(key)) {
            let cellValue = result[key] !== null && result[key] !== undefined ? result[key] : '0';

            // Converter o valor para número
            let numericValue = parseFloat(cellValue);

            // Verificar se o valor é um número inteiro
            if (numericValue % 1 === 0) {
              // Se for inteiro, não usar toFixed()
              cellValue = numericValue.toString();
            } else {
              // Se for decimal, usar toFixed() com 2 casas decimais
              cellValue = numericValue.toFixed(2).replace(/\./g, ',');
            }

            $('#' + fieldCellIds[key]).html(cellValue);
          }
        }

      // Soma dos campos desejados
      veg_nativa.lulc_formacaoflorestal = parseFloat(result.lulc_formacaoflorestal) || 0;
      veg_nativa.lulc_formacaosavanica = parseFloat(result.lulc_formacaosavanica) || 0;
      veg_nativa.lulc_mangue = parseFloat(result.lulc_mangue) || 0;
      veg_nativa.lulc_florestaalagavel = parseFloat(result.lulc_florestaalagavel) || 0;
      veg_nativa.lulc_campoalagadoeareapantanosa = parseFloat(result.lulc_campoalagadoeareapantanosa) || 0;
      veg_nativa.lulc_formacaocampestre = parseFloat(result.lulc_formacaocampestre) || 0;
      veg_nativa.lulc_pastagem = parseFloat(result.lulc_pastagem) || 0;
      veg_nativa.lulc_restingaarborea = parseFloat(result.lulc_restingaarborea) || 0;
      veg_nativa.lulc_restingaherbacea = parseFloat(result.lulc_restingaherbacea) || 0;

      lav_perenes.lulc_cafe = parseFloat(result.lulc_cafe) || 0;
      lav_perenes.lulc_citrus = parseFloat(result.lulc_citrus) || 0;
      lav_perenes.lulc_outraslavourasperenes = parseFloat(result.lulc_outraslavourasperenes) || 0;

      outras_lav_temporarias.lulc_arroz = parseFloat(result.lulc_arroz) || 0;
      outras_lav_temporarias.lulc_algodao = parseFloat(result.lulc_algodao) || 0;
      outras_lav_temporarias.lulc_outraslavourastemporarias = parseFloat(result.lulc_outraslavourastemporarias) || 0;
      
      // Calcular as somas totais
      const veg_nativa_somaTotal = Object.values(veg_nativa).reduce((acc, curr) => acc + curr, 0);       
      const lav_perenes_somaTotal = Object.values(lav_perenes).reduce((acc, curr) => acc + curr, 0);
      const outras_lav_temporarias_somaTotal = Object.values(outras_lav_temporarias).reduce((acc, curr) => acc + curr, 0);
      
      // Exibir as somas nas células
      $('#veg_nativa_tab').html(veg_nativa_somaTotal.toFixed(2).replace(/\./g, ',')); // Arredondar para 2 casas decimais
      $('#lav_perenes_tab').html(lav_perenes_somaTotal.toFixed(2).replace(/\./g, ',')); // Arredondar para 2 casas decimais
      $('#outras_lav_temporarias_tab').html(outras_lav_temporarias_somaTotal.toFixed(2).replace(/\./g, ',')); // Arredondar para 2 casas decimais  
      
    }
 
    
    // Adicione um ouvinte de evento 'pointermove' ao mapa
    map.on('pointermove', function (posicaodomouse) {
      const coordinate = posicaodomouse.coordinate;
      const viewResolution = /** @type {number} */ (view.getResolution());
      const url = info_municipios.getFeatureInfoUrl(
        posicaodomouse.coordinate,
        viewResolution,
          'EPSG:4326',
          {'INFO_FORMAT': 'application/json',
          'propertyName': 'nm_mun,sigla_uf',
          'exclude_nodata_result': 'true'},
        );
        fetch(url)
        .then((resp) => resp.json())
        .then(function(resposta) {
          const var1 = resposta['features'];
          if (var1 && var1.length > 0) { // Verificar se var1 está definida e não vazia
            const var2 = var1[0];
          const var3 = var2['properties']
          const nome_municipio = var3['nm_mun'] || 0;
          const uf_municipio = var3['sigla_uf'] || 0        
          

          posicao_text.innerHTML = `        
          <b>Município:</b> &nbsp;${nome_municipio} (${uf_municipio})<br>
          <b>Latitude:</b> &nbsp;${coordinate[1].toFixed(4)}<br>
          <b>Longitude:</b> &nbsp;${coordinate[0].toFixed(4)}<br>
          `
        } else {
        
        }
        })
    });   
  
    map.on('singleclick', function (evt) {
      const coordinate = evt.coordinate;
      const viewResolution = /** @type {number} */ (view.getResolution());
      const url = info_torres.getFeatureInfoUrl(
        evt.coordinate,
        viewResolution,
          'EPSG:4326',
          {'INFO_FORMAT': 'application/json',
          'propertyName': 'geom,referencia,projeto,torres,statusnegociacao,proprietario,telefone,municipio',
          'exclude_nodata_result': 'true'},
        );
        fetch(url)
        .then((resp) => resp.json())
        .then(function(resposta) {
          const var1 = resposta['features'];
          if (var1 && var1.length > 0) { // Verificar se var1 está definida e não vazia
            const var2 = var1[0];
            const geometria = var2['geometry']; // Acesso à geometria
          const var3 = var2['properties']
          const Referencia = var3['referencia'] || 0;
          const Projeto = var3['projeto'] || 0;
          const Torres = var3['torres'] || 0;
          const StatusNegociacao = var3['statusnegociacao'] || 0;
          const Proprietario = var3['proprietario'] || 0;   
          const Telefone = var3['telefone'] || 0;
          const VilaPovoado = var3['vilapovoado'] || 0;
          const Municipio = var3['municipio'] || 0;          
          map.removeLayer(vectorLayer); 
          map.removeLayer(pointLayer); 
          map.removeLayer(pointLayer_sel);
          map.removeLayer(pointLayer_sel_v2);     
          const coordenadas = geometria.coordinates
          const coordinates = coordenadas[0]     

         // Crie uma camada de recursos para adicionar o ponto ao mapa
        pointLayer_sel_v2 = new ol.layer.Vector({
          source: new ol.source.Vector(),
          projection: 'EPSG:4326'
        });

        // Defina um estilo para o ponto (ícone personalizado)
        const iconStyle = new ol.style.Style({
          image: new ol.style.Icon({
            src: '/images/icon_black.png', // Caminho para a imagem PNG
            scale: 1, // Tamanho do ícone
          }),
        });
      
        const pointFeature = new ol.Feature({
          geometry: new ol.geom.Point(coordinates),
          projection: 'EPSG:4326'
        });
      
        // Aplique o estilo ao recurso
        pointFeature.setStyle(iconStyle);
      
      
        // Adicione o recurso à camada de recursos
        pointLayer_sel_v2.getSource().addFeature(pointFeature);
      
        // Adicione a camada de recursos ao mapa
        map.addLayer(pointLayer_sel_v2);
      
        rel_torre_tab.innerHTML = `
        <div id="resultados">        
        <table class="table custom-table-width rounded-table small-table">                
                <tbody>
                    <tr id="referenciaRow">
                        <td class="small-font"><b>Referência:</b> ${Referencia}</td>
                    </tr>
                    <tr id="projetoRow">
                        <td class="small-font"><b>Projeto:</b> ${Projeto}</td>
                    </tr>   
                    <tr id="torresRow">
                        <td class="small-font"><b>Torres:</b> ${Torres}</td>
                    </tr>  
                    <tr id="statusnegociacaoRow">
                        <td class="small-font"><b>Status de Negociação:</b> ${StatusNegociacao}</td>
                    </tr>  
                    <tr id="proprietarioRow">
                      <td class="small-font"><b>Proprietário:</b> ${Proprietario}</td>
                  </tr>
                    <tr id="telefoneRow">
                        <td class="small-font"><b>Telefone:</b> ${Telefone}</td>
                    </tr>
                    <tr id="vilapovoadoRow">
                        <td class="small-font"><b>Vila/Povoado:</b> ${VilaPovoado}</td>
                    </tr>
                    <tr id="municipioRow">
                        <td class="small-font"><b>Município:</b> ${Municipio}</td>
                    </tr>
                </tbody>
            </table>
            </div>
            <div id="paginacao">
          </div>
        `               
        } else {
        }
      })
    }); 

    const pageContent = document.querySelector('.page-content');  
    const toggleSidebarLeft = document.getElementById('toggleSidebarLeft');
    const toggleSidebarRight = document.getElementById('toggleSidebarRight');

    // Seleciona o elemento "> Posição" e a div de conteúdo
    const posicaoToggle = document.getElementById("posicao-toggle");
    const posicaoContent = document.getElementById("posicao-content");

    // Adiciona um evento de clique ao elemento "> Posição"
    posicaoToggle.addEventListener("click", () => {

      // Altera a propriedade display da div de conteúdo
      if (posicaoContent.style.display === "none") {
        posicaoContent.style.display = "block";
      } else {
        posicaoContent.style.display = "none";
      }
    });

    // Seleciona o elemento "> Torres" e a div de conteúdo
    const lt_tropicaliaToggle = document.getElementById("lt_tropicalia-toggle");
    const lt_tropicaliaContent = document.getElementById("lt_tropicalia-content");

    // Adiciona um evento de clique ao elemento "> Torres"
    lt_tropicaliaToggle.addEventListener("click", () => {

      // Altera a propriedade display da div de conteúdo
      if (lt_tropicaliaContent.style.display === "none") {
        lt_tropicaliaContent.style.display = "block";
      } else {
        lt_tropicaliaContent.style.display = "none";
      }
    });

    // Seleciona o elemento "> Infraestrutura" e a div de conteúdo
    const infraestruturaToggle = document.getElementById("infraestrutura-toggle");
    const infraestruturaContent = document.getElementById("infraestrutura-content");

    // Seleciona o elemento "> Alertas" e a div de conteúdo
    const alertasToggle = document.getElementById("alertas-toggle");
    const alertasContent = document.getElementById("alertas-content");

    // Seleciona o elemento "> Alertas" e a div de conteúdo
    const ambientalToggle = document.getElementById("ambiental-toggle");
    const ambientalContent = document.getElementById("ambiental-content");

    // Adiciona um evento de clique ao elemento "> Infraestrutura"
    infraestruturaToggle.addEventListener("click", () => {

      // Altera a propriedade display da div de conteúdo
      if (infraestruturaContent.style.display === "none") {
        infraestruturaContent.style.display = "block";
      } else {
        infraestruturaContent.style.display = "none";
      }
    });

    // Adiciona um evento de clique ao elemento "> Alertas"
    alertasToggle.addEventListener("click", () => {
      
      // Altera a propriedade display da div de conteúdo
      if (alertasContent.style.display === "none") {
        alertasContent.style.display = "block";
      } else {
        alertasContent.style.display = "none";
      }
    });

    // Adiciona um evento de clique ao elemento "> Ambiental"
    ambientalToggle.addEventListener("click", () => {
  
      // Altera a propriedade display da div de conteúdo
      if (ambientalContent.style.display === "none") {
        ambientalContent.style.display = "block";
      } else {
        ambientalContent.style.display = "none";
      }
    });

    // Seleciona o elemento "> Limites" e a div de conteúdo
    const limitesToggle = document.getElementById("limites-toggle");
    const limitesContent = document.getElementById("limites-content");

    // Adiciona um evento de clique ao elemento "> Limites"
    limitesToggle.addEventListener("click", () => {

      // Altera a propriedade display da div de conteúdo
      if (limitesContent.style.display === "none") {
        limitesContent.style.display = "block";
      } else {
        limitesContent.style.display = "none";
      }
    });

    // Seleciona o elemento "> Basemap" e a div de conteúdo
    const basemapsToggle = document.getElementById("basemaps-toggle");
    const basemapsContent = document.getElementById("basemaps-content");

    // Adiciona um evento de clique ao elemento "> Basemaps"
    basemapsToggle.addEventListener("click", () => {

      // Altera a propriedade display da div de conteúdo
      if (basemapsContent.style.display === "none") {
        basemapsContent.style.display = "block";
      } else {
        basemapsContent.style.display = "none";
      }
    });

    // Seleciona o elemento de busca "> Torres" e a div de conteúdo
    const buscatorresToggle = document.getElementById("buscatorres-toggle");
    const buscatorresContent = document.getElementById("buscatorres-content");
  
    // Adiciona um evento de clique ao elemento "> Torres"
    buscatorresToggle.addEventListener("click", () => {

      // Altera a propriedade display da div de conteúdo
      if (buscatorresContent.style.display === "none") {
        buscatorresContent.style.display = "block";
      } else {
        buscatorresContent.style.display = "none";
      }
    });

    // Seleciona as checkboxes e as camadas de mapa correspondentes
    const faixa_servidao_cadastroCheckbox = document.getElementById("faixa_servidao_cadastro-checkbox");
    const eixoCheckbox = document.getElementById("eixo-checkbox");
    const torresCheckbox = document.getElementById("torres-checkbox");
    const acessosCheckbox = document.getElementById("acessos-checkbox");
    const edificacoesCheckbox = document.getElementById("edificacoes-checkbox");
    const ps_map_rf_2021Checkbox = document.getElementById("ps_map_rf_2021-checkbox");
    const ps_map_rf_2023Checkbox = document.getElementById("ps_map_rf_2023-checkbox");
    const imoveis_rurais_carCheckbox = document.getElementById("imoveis_rurais_car-checkbox");
    const imoveis_rurais_sigefCheckbox = document.getElementById("imoveis_rurais_sigef-checkbox");
    const imoveis_rurais_snciCheckbox = document.getElementById("imoveis_rurais_snci-checkbox");
    const assentamentosCheckbox = document.getElementById("assentamentos-checkbox");
    const terras_indigenasCheckbox = document.getElementById("terras_indigenas-checkbox");
    const ucs_piCheckbox = document.getElementById("ucs_pi-checkbox");
    const ucs_usCheckbox = document.getElementById("ucs_us-checkbox");
    const municipiosCheckbox = document.getElementById("municipios-checkbox");
    const ufCheckbox = document.getElementById("uf-checkbox");

    // Obtém as camadas de mapa existentes
    const faixa_servidao_cadastroLayer = map.getLayers().getArray().find(layer => layer.get('title') === 'faixa_servidao_cadastro');
    const eixoLayer = map.getLayers().getArray().find(layer => layer.get('title') === 'eixo');
    const torresLayer = map.getLayers().getArray().find(layer => layer.get('title') === 'torres');
    const acessosLayer = map.getLayers().getArray().find(layer => layer.get('title') === 'acessos');
    const edificacoesLayer = map.getLayers().getArray().find(layer => layer.get('title') === 'edificacoes');
    const ps_map_rf_2021Layer = map.getLayers().getArray().find(layer => layer.get('title') === 'ps_map_rf_2021');
    const ps_map_rf_2023Layer = map.getLayers().getArray().find(layer => layer.get('title') === 'ps_map_rf_2023');
    const imoveis_rurais_carLayer = map.getLayers().getArray().find(layer => layer.get('title') === 'imoveis_rurais_car'); 
    const imoveis_rurais_sigefLayer = map.getLayers().getArray().find(layer => layer.get('title') === 'imoveis_rurais_sigef'); 
    const imoveis_rurais_snciLayer = map.getLayers().getArray().find(layer => layer.get('title') === 'imoveis_rurais_snci'); 
    const assentamentosLayer = map.getLayers().getArray().find(layer => layer.get('title') === 'assentamentos'); 
    const terras_indigenasLayer = map.getLayers().getArray().find(layer => layer.get('title') === 'terras_indigenas'); 
    const ucs_piLayer = map.getLayers().getArray().find(layer => layer.get('title') === 'ucs_pi'); 
    const ucs_usLayer = map.getLayers().getArray().find(layer => layer.get('title') === 'ucs_us'); 
    const municipiosLayer = map.getLayers().getArray().find(layer => layer.get('title') === 'municipios'); 
    const ufLayer = map.getLayers().getArray().find(layer => layer.get('title') === 'uf'); 

    // Adiciona eventos de mudança às checkboxes
    faixa_servidao_cadastroCheckbox.addEventListener("change", () => {
      faixa_servidao_cadastroLayer.setVisible(faixa_servidao_cadastroCheckbox.checked);
    });

    eixoCheckbox.addEventListener("change", () => {
      eixoLayer.setVisible(eixoCheckbox.checked);
    });

    torresCheckbox.addEventListener("change", () => {
      torresLayer.setVisible(torresCheckbox.checked);
    });

    acessosCheckbox.addEventListener("change", () => {
      acessosLayer.setVisible(acessosCheckbox.checked);
    });

    edificacoesCheckbox.addEventListener("change", () => {
      edificacoesLayer.setVisible(edificacoesCheckbox.checked);
    });

    ps_map_rf_2021Checkbox.addEventListener("change", () => {
      ps_map_rf_2021Layer.setVisible(ps_map_rf_2021Checkbox.checked);
    });

    ps_map_rf_2023Checkbox.addEventListener("change", () => {
      ps_map_rf_2023Layer.setVisible(ps_map_rf_2023Checkbox.checked);
    });

      imoveis_rurais_carCheckbox.addEventListener("change", () => {
      imoveis_rurais_carLayer.setVisible(imoveis_rurais_carCheckbox.checked);
    });

    imoveis_rurais_sigefCheckbox.addEventListener("change", () => {
      imoveis_rurais_sigefLayer.setVisible(imoveis_rurais_sigefCheckbox.checked);
    });

    imoveis_rurais_snciCheckbox.addEventListener("change", () => {
      imoveis_rurais_snciLayer.setVisible(imoveis_rurais_snciCheckbox.checked);
    });

    assentamentosCheckbox.addEventListener("change", () => {
      assentamentosLayer.setVisible(assentamentosCheckbox.checked);
    });

    terras_indigenasCheckbox.addEventListener("change", () => {
      terras_indigenasLayer.setVisible(terras_indigenasCheckbox.checked);
    });

    ucs_piCheckbox.addEventListener("change", () => {
      ucs_piLayer.setVisible(ucs_piCheckbox.checked);
    });

    ucs_usCheckbox.addEventListener("change", () => {
      ucs_usLayer.setVisible(ucs_usCheckbox.checked);
    });

    municipiosCheckbox.addEventListener("change", () => {
      municipiosLayer.setVisible(municipiosCheckbox.checked);
    });

    ufCheckbox.addEventListener("change", () => {
      ufLayer.setVisible(ufCheckbox.checked);
    });

    // Expanda a barra lateral esquerda e ajuste o botão ao abrir a página
    sidebarLeft.style.left = '0px';
    toggleSidebarLeft.style.left = '350px';

    // Expanda a barra lateral direita e ajuste o botão ao abrir a página
    sidebarRight.style.right = '0px';
    toggleSidebarRight.style.right = '450px';

    // Adicione os eventos de clique para alternar as barras laterais
    toggleSidebarLeft.addEventListener('click', () => {
      if (sidebarLeft.style.left === '0px') {
        sidebarLeft.style.left = '-350px';
        toggleSidebarLeft.style.left = '10px';
      } else {
        sidebarLeft.style.left = '0px';
        toggleSidebarLeft.style.left = '350px';
      }
    });

    toggleSidebarRight.addEventListener('click', () => {
      if (sidebarRight.style.right === '0px') {
        sidebarRight.style.right = '-450px';
        toggleSidebarRight.style.right = '10px';
      } else {
        sidebarRight.style.right = '0px';
        toggleSidebarRight.style.right = '450px';
      }
    });
  }
  </script>
</body>
</html>
